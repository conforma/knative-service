# Copyright The Conforma Contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

name: PR Comment

on:
  workflow_run:
    workflows: ["PR Validation"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  comment:
    name: Add PR Comment
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    
    steps:
    - name: Download validation results
      uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
      with:
        name: validation-results
        github-token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        run-id: ${{ github.event.workflow_run.id }}

    - name: Read validation context
      id: context
      run: |
        if [ -f validation-context.txt ]; then
          cat validation-context.txt >> $GITHUB_OUTPUT
        else
          echo "pr_number=" >> $GITHUB_OUTPUT
          echo "job_status=unknown" >> $GITHUB_OUTPUT
        fi

    - name: Comment on PR - Success
      if: steps.context.outputs.job_status == 'success'
      uses: peter-evans/create-or-update-comment@c6c9a1a66007646a28c153e2a8580a5bad27bcfa # v4.0.0
      with:
        issue-number: ${{ steps.context.outputs.pr_number }}
        body: |
          ## ✅ Validation Successful
          
          All checks passed! Your PR is ready for review.
          
          **Validation Results:**
          - ✅ Code formatting
          - ✅ License headers
          - ✅ Unit tests
          - ✅ Linting
          - ✅ Kubernetes manifests
          - ✅ Container build
          - ✅ Security scan
          
          <details>
          <summary>View workflow details</summary>
          
          **Workflow:** [${{ github.event.workflow_run.name }}](${{ github.event.workflow_run.html_url }})
          **Commit:** ${{ github.event.workflow_run.head_sha }}
          </details>

    - name: Comment on PR - Failure
      if: steps.context.outputs.job_status != 'success'
      uses: peter-evans/create-or-update-comment@c6c9a1a66007646a28c153e2a8580a5bad27bcfa # v4.0.0
      with:
        issue-number: ${{ steps.context.outputs.pr_number }}
        body: |
          ## ❌ Validation Failed
          
          Some checks failed. Please review and fix the issues.
          
          **Next Steps:**
          1. Check the [workflow logs](${{ github.event.workflow_run.html_url }}) for details
          2. Fix any failing checks locally:
             - Format: `go fmt ./...`
             - License headers: `make license-add`
             - Tests: `go test ./...`
             - Lint: `golangci-lint run`
          3. Push your fixes to update this PR
          
          <details>
          <summary>View workflow details</summary>
          
          **Workflow:** [${{ github.event.workflow_run.name }}](${{ github.event.workflow_run.html_url }})
          **Commit:** ${{ github.event.workflow_run.head_sha }}
          **Status:** ${{ steps.context.outputs.job_status }}
          </details>
