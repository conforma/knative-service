# Copyright The Conforma Contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

name: Acceptance Tests

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ main ]

# Prevent multiple workflows from running simultaneously
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.24.7'
  KNATIVE_VERSION: 'v1.18.2'

permissions:
  contents: read

jobs:
  acceptance-tests:
    name: Run Acceptance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Set up Go
      uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      with:
        path: |
          ~/go/pkg/mod
          ~/.cache/go-build
        key: ${{ runner.os }}-go-acceptance-${{ hashFiles('acceptance/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-acceptance-
          ${{ runner.os }}-go-

    - name: Install ko
      uses: ko-build/setup-ko@d006021bd0c28d1ce33a07e7943d48b079944c8d # v0.9

    - name: Install Knative CLI
      run: |
        echo "Installing Knative CLI..."
        curl -Lo kn https://github.com/knative/client/releases/download/knative-v1.18.0/kn-linux-amd64
        chmod +x kn
        sudo mv kn /usr/local/bin/
        kn version

    - name: Install kustomize
      run: |
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin/

    - name: Download dependencies
      run: |
        echo "Downloading Go dependencies..."
        go mod download
        go mod download -modfile acceptance/go.mod

    - name: Run acceptance tests
      run: |
        echo "Running acceptance tests..."
        echo "Note: Using shared Kind cluster for all scenarios"
        echo "Cluster startup takes ~2-3 minutes"
        make acceptance
      env:
        # Limit concurrency to prevent test interference on shared Kind cluster
        ACCEPTANCE_CONCURRENCY: 2
        # Go test configuration
        CGO_ENABLED: 1

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: acceptance-test-results
        path: |
          acceptance/*.log
          acceptance/test-results/
        retention-days: 7
        if-no-files-found: ignore

    - name: Generate test summary
      if: always()
      run: |
        echo "## Acceptance Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ job.status }}" = "success" ]; then
          echo "✅ All acceptance tests passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Some acceptance tests failed!" >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
        fi
